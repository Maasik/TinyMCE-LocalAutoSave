/**
 * LAS - Local Auto Save Plugin
 * localautosave/plugin.js
 *
 * Released under Creative Commons Attribution 3.0 Unported License
 *
 * License: http://creativecommons.org/licenses/by/3.0/
 * Author: Felipe Valtl de Mello
 *
 * Version: 0.1 released 10/07/2013
 */

tinymce.PluginManager.requireLangPack('localautosave');
tinymce.PluginManager.add("localautosave", function (e, url) {

    /**
    * ########################################
    *     Define as variáveis para o plugin
    * ########################################
    */
    var $form = $(e.formElement),

         $useLocalStorage = false,

         $useSessionStorage = false,

         $editorID = e.id,

         $busy = false,

         cookieEncodeKey = {"%": "%1", "&": "%2", ";": "%3", "=": "%4", "<": "%5"},
         cookieDecodeKey = {"%1": "%", "%2": "&", "%3": ";", "%4": "=", "%5": "<"},
         settings = { 
            seconds: e.getParam('las_seconds') || 15000,
            keyName: e.getParam('las_keyName') || 'LocalAutoSave',
            callback: e.getParam('las_callback')
        };

    /**
    * ########################################
    *     Verifica qual o meio suportado pelo 
    *     navegador para salvar o conteúdo
    * ########################################
    */
    try {
        localStorage.setItem('LASTest', "OK");
        
        if (localStorage.getItem('LASTest') === "OK") {
            localStorage.removeItem('LASTest');
            $useLocalStorage = true;
        }
    }
    catch (erro) {

        try {
            sessionStorage.setItem('LASTest', "OK");
            
            if (sessionStorage.getItem('LASTest') === "OK") {
                sessionStorage.removeItem('LASTest');
                $useSessionStorage = true;
            }
        }
        catch (erro) {

        }
    }

    /**
    * ########################################
    *     Cria botão para restaurar conteúdo
    * ########################################
    */
    var button = e.addButton("localautosave", {
        text: "",
        icon: 'restoredraft',
        tooltip: 'Restore content',
        onclick: function () {
            restore()
        }
    })

    /**
    * ########################################
    *     Codifica caracteres especiais para
    *     salvar no cookie do navegador
    * ########################################
    */
    function encodeCookie(str) {
        return str.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi, " ").replace(/(.)\1{5,}|[%&;=<]/g,
            function (c) {
                if (c.length > 1) {
                    return ("%0" + c.charAt(0) + c.length.toString() + "%");
                }
                return cookieEncodeKey[c];
            }
            );
    }
    
    /**
    * ########################################
    *     Descodifica caracteres especiais 
    *     para salvar no cookie do navegador
    * ########################################
    */
    function decodeCookie(str) {
        return str.replace(/%[1-5]|%0(.)(\d+)%/g,
            function (c, m, d) {
                var a, i, l;
                
                if (c.length == 2) {
                    return cookieDecodeKey[c];
                }
                
                for (a=[], i=0, l=parseInt(d); i<l; i++) {
                    a.push(m);
                }
                
                return a.join("");
            });
    }
    
    /**
    * ########################################
    *     Codifica caracteres especiais para
    *     salvar no storage do navegador
    * ########################################
    */
    function encodeStorage(str) {
        return str.replace(/,/g, "&#44;");
    }
    
    /**
    * ########################################
    *     Descodifica caracteres especiais 
    *     para salvar no storage do navegador
    * ########################################
    */
    function decodeStorage(str) {
        return str.replace(/&#44;/g, ",");
    }

    /**
    * ########################################
    *     Ação de salvar o conteúdo
    * ########################################
    */
    var save = function() {
        if($busy === false) {
            content = e.getContent();
            is = e.editorManager.is;
            if (is(content, "string") && (content.length > 0)) {
                now = new Date();
                exp = new Date(now.getTime() + (20 * 60 * 1000));
                try {
                    if ($useLocalStorage) {
                        localStorage.setItem('LocalAutoSave'+$editorID, exp.toString() + "," + encodeStorage(content));
                    } else if ($useSessionStorage) {
                        sessionStorage.setItem('LocalAutoSave'+$editorID, exp.toString() + "," + encodeStorage(content));
                    } else {
                        a = s.dataKey + "=";
                        b = "; expires=" + exp.toUTCString();
                        
                        document.cookie = a + encodeCookie(content).slice(0, 4096 - a.length - b.length) + b;
                    }  
                    saved = true;
                }
                catch (erro) {
                    console.log(erro);
                }

                if(saved === true) {
                    var btn = getButtonByName('localautosave');
                    $(btn).find('i').replaceWith('<i class="mce-ico mce-i-none" style="background: url(\'' + url + '/img/progress.gif\') no-repeat;"></i>');
                    var t = setTimeout(function(){
                        $(btn).find('i').replaceWith('<i class="mce-ico mce-i-restoredraft"></i>');
                    },3000)
                }
            }
        }
    }
    /**
    * ########################################
    *     Define o intervalo para salvar
    *     o conteúdo
    * ########################################
    */
    var interval = setInterval(save, 10 *1000);

    /**
    * ########################################
    *     Ação de restaurar o conteúdo
    * ########################################
    */
    function restore() {
       var content = null,
            is = e.editorManager.is;
        $busy = true;
        try {
            if ($useLocalStorage || $useSessionStorage) {
                content = (($useLocalStorage? localStorage.getItem('LocalAutoSave'+$editorID) : sessionStorage.getItem('LocalAutoSave'+$editorID)) || "").toString();
                i = content.indexOf(",");

                if (i == -1) {
                    content = null;
                } else {
                    content = decodeStorage(content.slice(i + 1, content.length));
                }
            } else {
                m = document.cookie;
                if (m) {
                    content = decodeCookie(m[1]);
                }
            }
            if (!is(content, "string")) {
                e.windowManager.alert('There is no content available to restore.');
            } else {
                if (e.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi, "").length === 0) {
                    e.setContent(content);
                    $busy = false;
                } else {
                     e.windowManager.confirm(
                        'If you restore the saved content, you will lose all the content that is currently in the editor.\n\nAre you sure you want to restore the saved content?',
                        function (ok) {
                            if (ok) {
                                e.setContent(content);
                            }
                            $busy = false;
                        }, this);
                }
            }
        } catch (erro) {
            console.log(erro);
            $busy = false;
        }
    }

    /**
    * ########################################
    *     Pega o DOM de um botão pelo nome
    * ########################################
    */
    function getButtonByName(name, getEl) {
        var ed = e,    
        buttons = ed.buttons,
        toolbarObj = ed.theme.panel.find('toolbar *'),
        un = 'undefined';

        if(typeof buttons[name] === un)
            return false;
        
        var settings = buttons[name], result = false, length = 0;
        
        tinymce.each(settings, function(v, k){
            length++;
        });
        
        tinymce.each(toolbarObj, function(v, k) {
            if (v.type != 'button' || typeof v.settings === un)
                return;

            var i = 0;

            tinymce.each(v.settings, function (v, k) {
                if(settings[k] == v)
                    i++;
            });

            if(i != length)
                return;
            
            result = v;

            if(getEl != false)
                result = v.getEl();
            
            return false;
        });
        
        return result;
    }
});